<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thallos LLM Query</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; max-width: 900px; margin: 40px auto; }
    textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; }
    button { min-width: 160px; border: 0; border-radius: 8px; background: #111; color: #fff; padding: 12px 16px; cursor: pointer; }
    .card { padding: 12px; background: #f6f6f6; border-radius: 8px; margin: 16px 0; white-space: pre-wrap; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  </style>
</head>
<body>
  <h1>Thallos LLM Query</h1>
  <p style="color:#555;margin-top:0">Model → SQL → guarded execution on Supabase → summary.</p>

  <form id="qform">
    <textarea id="q" rows="3" placeholder="Ask a complex question…">Over the last 7 days, what were the min, max, and average USDC utilization?</textarea>
    <div style="margin-top:12px"><button id="submit" type="submit">Ask</button></div>
  </form>

  <div id="answer" class="card" style="display:none"></div>
  <div id="sql" class="card mono" style="display:none"></div>
  <div id="rows" class="card mono" style="display:none"></div>

  <script>
    const form = document.getElementById('qform');
    const textarea = document.getElementById('q');
    const submitBtn = document.getElementById('submit');
    const answerEl = document.getElementById('answer');
    const sqlEl = document.getElementById('sql');
    const rowsEl = document.getElementById('rows');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      answerEl.style.display = sqlEl.style.display = rowsEl.style.display = 'none';
      answerEl.textContent = sqlEl.textContent = rowsEl.textContent = '';

      submitBtn.disabled = true; submitBtn.textContent = 'Running…';
      try {
        // Call the server route directly (same-origin bypass is handled in /api/query)
        const resp = await fetch('/api/query', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ question: textarea.value })
        });
        const data = await resp.json();
        if (!data.ok) throw new Error(data.error || 'Query failed');

        answerEl.style.display = 'block';
        answerEl.textContent = `Answer:\n\n${data.answer || '(no summary)'}`;

        if (data.sql) { sqlEl.style.display = 'block'; sqlEl.textContent = `SQL:\n\n${data.sql}`; }
        if (Array.isArray(data.rows)) {
          rowsEl.style.display = 'block';
          rowsEl.textContent = `Rows (first 10):\n\n${JSON.stringify(data.rows.slice(0,10), null, 2)}`;
        }
      } catch (err) {
        answerEl.style.display = 'block';
        answerEl.textContent = `Error: ${err.message}`;
      } finally {
        submitBtn.disabled = false; submitBtn.textContent = 'Ask';
      }
    });
  </script>
</body>
</html>